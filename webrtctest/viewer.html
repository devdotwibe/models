<!DOCTYPE html>
<html>
<head><title>Viewer</title></head>
<body>
  <h2>Viewer</h2>
  <video id="remote" autoplay playsinline></video>

  <script>
    const remoteVideo = document.getElementById("remote");
    const socket = new WebSocket("wss://models.staging3.dotwibe.com/webrtcsocket");
    let peer = new RTCPeerConnection({
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:turn01.hubl.in?transport=udp"},
            { urls: "turn:turn01.hubl.in?transport=tcp"}
        ]
    });
    let iscandidate=true;
    let isoffer=true;

    peer.ontrack = e => {
      remoteVideo.srcObject = e.streams[0];
    };

    peer.onicecandidate = e => {
      if (e.candidate) socket.send(JSON.stringify({event:"view-candidate",data: e.candidate }));
    };

    socket.onmessage = async ({ data }) => {
      const msg = JSON.parse(data);

      if (msg.event=="stream-offer"&&isoffer) {
        isoffer=false;
        await peer.setRemoteDescription(new RTCSessionDescription(msg.data));
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);
        socket.send(JSON.stringify({event:"view-answer",data: answer }));
      } else if (msg.event=="stream-candidate"&&iscandidate) {
        iscandidate=false;
        await peer.addIceCandidate(new RTCIceCandidate(msg.data));
        socket.send(JSON.stringify({event:"request-offer",data: true }));
      }
    };
  </script>
</body>
</html>
