<!DOCTYPE html>
<html>
<head><title>Broadcaster</title></head>
<body>
  <h2>Broadcaster</h2>
  <video id="local" autoplay muted playsinline></video>

  <script>
    const localVideo = document.getElementById("local");
    const socket = new WebSocket("wss://models.staging3.dotwibe.com/webrtcsocket");
    let peer;
    let streamcandidate=null;
    let streamoffer=null;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localVideo.srcObject = stream;

      peer = new RTCPeerConnection({
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:turn01.hubl.in?transport=udp"},
            { urls: "turn:turn01.hubl.in?transport=tcp"}
        ]
    });
      stream.getTracks().forEach(track => peer.addTrack(track, stream));

      peer.onicecandidate = e => {
        if (e.candidate){
            streamcandidate=e.candidate;
            socket.send(JSON.stringify({ event:"stream-candidate",data: e.candidate }));
        }
      };

      peer.createOffer().then(offer => {
        peer.setLocalDescription(offer);
        streamoffer=offer;
        socket.send(JSON.stringify({ event:"stream-offer",data:offer }));
      });
    });

    socket.onmessage = async ({ data }) => {
      const msg = JSON.parse(data);

      if (msg.event=="view-answer") {
        await peer.setRemoteDescription(new RTCSessionDescription(msg.data));
      } else if (msg.event=="view-candidate") {
        await peer.addIceCandidate(new RTCIceCandidate(msg.data));
        socket.send(JSON.stringify({ event:"stream-candidate",data: streamcandidate }));
      }else if(msg.event=="request-offer"){
        socket.send(JSON.stringify({ event:"stream-offer",data:streamoffer }));

      }
    };
  </script>
</body>
</html>
