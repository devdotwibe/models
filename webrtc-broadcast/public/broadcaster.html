<!DOCTYPE html>
<html>
<head>
  <title>Broadcaster</title>
</head>
<body>
  <h2>Broadcaster</h2>
  <video id="localVideo" autoplay muted playsinline></video>

  <script>
    const localVideo = document.getElementById("localVideo");
    const socket = new WebSocket("wss://models.staging3.dotwibe.com:8080");

    const peerConnections = {};

    const iceConfig = {
      iceServers: [
        {
          urls: [
            'stun:stun.l.google.com:19302',
            'stun:stun1.l.google.com:19302',
            'stun:stun2.l.google.com:19302'
          ]
        }
      ]
    };

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localVideo.srcObject = stream;

        socket.onmessage = async ({ data }) => {
          const msg = JSON.parse(data);

          if (msg.type === "viewer") {
            const pc = new RTCPeerConnection(iceConfig);

            stream.getTracks().forEach(track => pc.addTrack(track, stream));

            pc.onicecandidate = event => {
              if (event.candidate) {
                socket.send(JSON.stringify({
                  type: "candidate",
                  to: msg.from,
                  candidate: event.candidate
                }));
              }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            socket.send(JSON.stringify({
              type: "offer",
              to: msg.from,
              offer: offer
            }));

            peerConnections[msg.from] = pc;
          } else if (msg.type === "answer" && peerConnections[msg.from]) {
            await peerConnections[msg.from].setRemoteDescription(new RTCSessionDescription(msg.answer));
          } else if (msg.type === "candidate" && peerConnections[msg.from]) {
            await peerConnections[msg.from].addIceCandidate(new RTCIceCandidate(msg.candidate));
          }
        };
      });
  </script>
</body>
</html>
