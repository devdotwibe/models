<!DOCTYPE html>
<html>
<head>
  <title>Viewer</title>
</head>
<body>
  <h2>Viewer</h2>
  <video id="remoteVideo" autoplay playsinline></video>

  <script>
    const remoteVideo = document.getElementById("remoteVideo");
    const socket = new WebSocket("wss://models.staging3.dotwibe.com:8080");

    const pc = new RTCPeerConnection({
      iceServers: [
        {
          urls: [
            'stun:stun.l.google.com:19302',
            'stun:stun1.l.google.com:19302',
            'stun:stun2.l.google.com:19302'
          ]
        }
      ]
    });

    socket.onopen = () => {
      socket.send(JSON.stringify({ type: "viewer" }));
    };

    socket.onmessage = async ({ data }) => {
      const msg = JSON.parse(data);

      if (msg.type === "offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        socket.send(JSON.stringify({ type: "answer", answer: answer }));
      } else if (msg.type === "candidate") {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
    };

    pc.ontrack = event => {
      remoteVideo.srcObject = event.streams[0];
    };

    pc.onicecandidate = event => {
      if (event.candidate) {
        socket.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
      }
    };
  </script>
</body>
</html>
