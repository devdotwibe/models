<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Broadcast</title>
</head>
<body>
  <h2>WebRTC Live Broadcast</h2>
<button id="start">Start Stream</button>
<video id="localVideo" autoplay muted></video>

<script>
let localStream, pc;
const roomId = 'room123';
const roomConnections = {};

document.getElementById('start').onclick = async () => {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('localVideo').srcObject = localStream;
    pollViewers();
    setInterval(pollViewers, 1000);
};

async function pollViewers() {
    const res = await fetch(`signal.php?action=get_viewers&room_id=${roomId}`);
    const viewers = await res.json();

    for (const viewerId in viewers) {
        const viewer = viewers[viewerId];

        // 1. Send offer if not already sent
        if (!roomConnections[viewerId]) {
            const conn = new RTCPeerConnection();
            localStream.getTracks().forEach(track => conn.addTrack(track, localStream));

            conn.onicecandidate = e => {
                if (e.candidate) {
                    sendSignal('ice', viewerId, e.candidate);
                }
            };

            const offer = await conn.createOffer();
            await conn.setLocalDescription(offer);
            sendSignal('offer', viewerId, offer);
            conn._remoteSet = false;
            roomConnections[viewerId] = conn;
        }

        // 2. Set answer from viewer if available
        if (viewer.answer && !roomConnections[viewerId]._remoteSet) {
            await roomConnections[viewerId].setRemoteDescription(new RTCSessionDescription(viewer.answer));
            roomConnections[viewerId]._remoteSet = true;
        }

        // 3. Handle ICE
        if (viewer.ice) {
            viewer.ice.forEach(async candidate => {
                try {
                    await roomConnections[viewerId].addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) {
                    console.warn("ICE error", e);
                }
            });
        }
    }
}

function sendSignal(type, to, data) {
    fetch(`signal.php?action=send&room_id=${roomId}&to=${to}&type=${type}`, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
    });
}
</script>
</body>
</html>
