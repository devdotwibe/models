<!DOCTYPE html>
<html>
<head>
  <title>WebRTC Broadcast</title>
</head>
<body>
  <h2>WebRTC Live Broadcast</h2>

  <video id="localVideo" autoplay muted playsinline width="400" height="300" style="border:1px solid black;"></video>
  <video id="remoteVideo" autoplay playsinline width="400" height="300" style="border:1px solid black;"></video>

  <script>
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get('room_id');
    const role = params.get('role'); // 'streamer' or 'viewer'

    let roomConnections = {};
    let localStream;
    let viewerId = Math.floor(Math.random() * 100000);
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    if (!roomId || !role) {
      alert("Missing room_id or role in URL");
    } else if (role === 'streamer') {
      startBroadcast();
    } else if (role === 'viewer') {
      startViewer();
    }

    // --- STREAMER LOGIC ---
    function startBroadcast() {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
        document.getElementById('localVideo').srcObject = stream;
        localStream = stream;
        setInterval(pollViewers, 3000);
      });
    }

    async function pollViewers() {
      const res = await fetch(`signal.php?action=get_viewers&room_id=${roomId}`);
      const viewers = await res.json();

      for (const vId in viewers) {
        const v = viewers[vId];

        // Create new connection if not already
        if (!v.offer && !v.sent && !roomConnections[vId]) {
          const pc = new RTCPeerConnection(config);
          roomConnections[vId] = pc;

          localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

          pc.onicecandidate = e => {
            if (e.candidate) {
              sendSignal("ice", vId, e.candidate);
            }
          };

          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          sendSignal("offer", vId, offer);
        }

        // Check for viewer's answer
        if (v.answer && roomConnections[vId]) {
          const pc = roomConnections[vId];
          if (!pc.remoteDescription) {
            try {
              await pc.setRemoteDescription(new RTCSessionDescription(v.answer));
            } catch (err) {
              console.error("Set remote answer failed:", err);
            }
          }
        }
      }
    }

    function sendSignal(type, viewer, data) {
      fetch("signal.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: type, room_id: roomId, viewer, data })
      });
    }

    // --- VIEWER LOGIC ---
   async function startViewer() {
  const pc = new RTCPeerConnection(config);

  // Display the received stream
  pc.ontrack = e => {
    const remoteVideo = document.getElementById('remoteVideo');
    if (!remoteVideo.srcObject) {
      remoteVideo.srcObject = e.streams[0];
    }
  };

  // Send ICE candidates back to streamer
  pc.onicecandidate = e => {
    if (e.candidate) {
      sendViewerSignal("ice", e.candidate);
    }
  };

  // Register viewer to server
  await fetch("signal.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "register_viewer",
      room_id: roomId,
      viewer: viewerId
    })
  });

  const receivedIce = new Set();

  // Poll to get offer + ICE and respond with answer
  setInterval(async () => {
    const res = await fetch(`signal.php?action=get_offer&room_id=${roomId}&viewer=${viewerId}`);
    const data = await res.json();

    // Set remote offer and send answer
    if (data.offer && !pc.remoteDescription) {
      try {
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        sendViewerSignal("answer", answer);
      } catch (err) {
        console.error("Error handling offer:", err);
      }
    }

    // Add new ICE candidates (avoid duplicates)
    if (Array.isArray(data.ice)) {
      for (const candidate of data.ice) {
        const key = JSON.stringify(candidate);
        if (!receivedIce.has(key)) {
          receivedIce.add(key);
          try {
            await pc.addIceCandidate(new RTCIceCandidate(candidate));
          } catch (err) {
            console.warn("Failed to add ICE:", err);
          }
        }
      }
    }
  }, 2000);
}

function sendViewerSignal(type, data) {
  fetch("signal.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: type,
      room_id: roomId,
      viewer: viewerId,
      data: data
    })
  });
}


  </script>
</body>
</html>
