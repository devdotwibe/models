<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Viewer (AJAX signaling)</title>
  <style>body{font-family:Arial;padding:16px}video{width:60%;}</style>
</head>
<body>
  <h1>Viewer</h1>
  <label>Room ID: <input id="room" value="room123"></label>
  <button id="joinBtn">Join Stream</button>
  <div style="margin-top:12px;">
    <video id="remoteVideo" autoplay playsinline></video>
  </div>
  <pre id="log" style="background:#111;color:#bde;padding:8px;height:160px;overflow:auto;"></pre>

<script>
const SIGNAL_URL = 'signaling.php';
const ICE = [{urls:'stun:stun.l.google.com:19302'}];

let pc = null;
let room = null;
let peerId = null;

const logEl = document.getElementById('log');
function log(...args){ console.log(...args); logEl.textContent += args.map(a=> typeof a==='object' ? JSON.stringify(a) : String(a)).join(' ') + '\\n'; logEl.scrollTop = 99999; }

async function ajaxGET(params){
  const q = new URLSearchParams(params);
  const r = await fetch(`${SIGNAL_URL}?${q.toString()}`);
  return r.json();
}
async function ajaxPOST(params){
  const body = new URLSearchParams(params);
  const r = await fetch(SIGNAL_URL + '?room=' + encodeURIComponent(room), { method: 'POST', body });
  return r.json();
}

document.getElementById('joinBtn').addEventListener('click', joinStream);

function genPeerId(){ return 'peer_' + Math.floor(Math.random()*1000000) + '_' + Date.now(); }

async function joinStream(){
  room = document.getElementById('room').value.trim();
  if (!room) return alert('enter room');

  // check room status first (ensure streamer started)
  const status = await ajaxGET({ room, status:1 });
  if (!status.meta || !status.meta.streamer_started) {
    return alert('No streamer started in that room yet.');
  }

  peerId = genPeerId();
  pc = new RTCPeerConnection({ iceServers: ICE });

  pc.ontrack = e => {
    document.getElementById('remoteVideo').srcObject = e.streams[0];
    log('Got remote stream');
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      ajaxPOST({ type:'candidate', peer:peerId, payload: JSON.stringify(e.candidate) }).catch(()=>{});
    }
  };

  // Viewer creates offer (no local tracks) because streamer will send media
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // send offer to server
  await ajaxPOST({ type:'offer', peer:peerId, payload: JSON.stringify(pc.localDescription) });
  log('Sent offer for peer', peerId);

  // start polling to fetch answer + candidates
  pollLoop();
  setInterval(pollLoop, 1400);
}

async function pollLoop(){
  if (!room || !peerId || !pc) return;
  const res = await ajaxGET({ room, role:'viewer', peer:peerId, consume:1 });
  if (!res) return;

  if (res.answer) {
    try {
      await pc.setRemoteDescription(JSON.parse(res.answer));
      log('Applied remote answer');
    } catch(e){ log('remoteDesc err', e); }
  }
  if (res.candidates && res.candidates.length) {
    for (const c of res.candidates) {
      try { await pc.addIceCandidate(JSON.parse(c)); } catch(e){ log('cand add err', e); }
    }
  }
}
</script>
</body>
</html>
