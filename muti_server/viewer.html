<!DOCTYPE html>
<html>
<head>
  <title>Viewer</title>
  <style>
    body { font-family: Arial; margin:20px; }
    video { width: 400px; border:1px solid #ccc; margin:10px; }
  </style>
</head>
<body>
  <h2>Viewer</h2>
  <label>Room ID: <input id="room" value="room123"></label>
  <button id="join">Join Stream</button>

  <h3>Remote Stream</h3>
  <video id="remoteVideo" autoplay playsinline></video>

<script>
const ICE_SERVERS = [{urls: "stun:stun.l.google.com:19302"}];
let room, peerId, pc;

function ajax(url, method="GET", data=null) {
  return fetch(url, {
    method,
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body: data ? new URLSearchParams(data) : null
  }).then(r => r.json());
}

async function startViewer() {
  room = document.getElementById("room").value;
  peerId = "peer_" + Math.floor(Math.random()*1000000);
  pc = new RTCPeerConnection({iceServers: ICE_SERVERS});

  pc.ontrack = e => document.getElementById("remoteVideo").srcObject = e.streams[0];

  pc.onicecandidate = e => {
    if (e.candidate) {
      ajax("signaling.php?room="+room, "POST", {
        type:"candidates", peer:peerId, payload:JSON.stringify(e.candidate)
      });
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await ajax("signaling.php?room="+room, "POST", {
    type:"offers", peer:peerId, payload:JSON.stringify(offer)
  });

  poll();
}

async function poll() {
  setInterval(async () => {
    const data = await ajax("signaling.php?room="+room);

    // find my answer
    for (const ans of data.answers) {
      if (ans.peer === peerId && !pc.currentRemoteDescription) {
        await pc.setRemoteDescription(JSON.parse(ans.payload));
      }
    }

    // // find candidates for me
    // for (const cand of data.candidates) {
    //   if (cand.peer !== peerId) continue;
    //   try { await pc.addIceCandidate(JSON.parse(cand.payload)); } catch(e) {}
    // }
    
    for (const ans of data.answers) {
        if (ans.peer === peerId && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(JSON.parse(ans.payload));
        }
    }

  }, 2000);
}

document.getElementById("join").onclick = startViewer;
</script>
</body>
</html>
