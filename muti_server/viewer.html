<!DOCTYPE html>
<html>
<head>
  <title>Viewer</title>
</head>
<body>
<h2>Viewer</h2>
<video id="remoteVideo" autoplay playsinline></video>
<script>
const roomId = "room123"; // same as streamer
const roomUrl = "signaling.php?room=" + roomId;
const peerId = "peer_" + Math.floor(Math.random()*1000000);
let pc;

async function init() {
  pc = new RTCPeerConnection();

  pc.ontrack = e => {
    document.getElementById("remoteVideo").srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if (e.candidate) {
      fetch(roomUrl + "&action=candidate", {
        method: "POST",
        body: JSON.stringify({ peer: peerId, candidate: e.candidate }),
      });
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  await fetch(roomUrl + "&action=offer", {
    method: "POST",
    body: JSON.stringify({ peer: peerId, offer }),
  });

  pollForAnswer();
}

async function pollForAnswer() {
  const res = await fetch(roomUrl + "&action=state");
  const state = await res.json();

  if (state.answers && state.answers[peerId]) {
    const answer = state.answers[peerId];
    await pc.setRemoteDescription(new RTCSessionDescription(answer));
    console.log("âœ… Got remote answer");
    return;
  }

  setTimeout(pollForAnswer, 2000);
}

init();
</script>
</body>
</html>
