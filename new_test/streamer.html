<!DOCTYPE html>
<html>
<head>
  <title>Streamer</title>
  <style>
    body { font-family: Arial; margin:20px; }
    video { width: 400px; border:1px solid #ccc; margin:10px; }
  </style>
</head>
<body>
  <h2>Streamer</h2>
  <label>Room ID: <input id="room" value="room123"></label>
  <button id="start">Start Stream</button>

  <h3>Local Stream</h3>
  <video id="localVideo" autoplay playsinline muted></video>

<script>
const ICE_SERVERS = [{urls: "stun:stun.l.google.com:19302"}];
let pc, room;

function ajax(url, method="GET", data=null) {
  return fetch(url, {
    method,
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body: data ? new URLSearchParams(data) : null
  }).then(r => r.json());
}

async function startStreamer() {
  room = document.getElementById("room").value;
  pc = new RTCPeerConnection({iceServers: ICE_SERVERS});

  const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
  document.getElementById("localVideo").srcObject = stream;
  stream.getTracks().forEach(track => pc.addTrack(track, stream));

  pc.onicecandidate = e => {
    if (e.candidate) {
      ajax("signaling.php?room="+room, "POST", {
        type: "candidates", payload: JSON.stringify(e.candidate)
      });
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await ajax("signaling.php?room="+room, "POST", {
    type: "offers", payload: JSON.stringify(offer)
  });

  poll();
}

async function poll() {
  setInterval(async () => {
    const data = await ajax("signaling.php?room="+room);
    for (const ans of data.answers) {
      if (!pc.currentRemoteDescription && ans.payload) {
        await pc.setRemoteDescription(JSON.parse(ans.payload));
      }
    }
    for (const cand of data.candidates) {
      try { await pc.addIceCandidate(JSON.parse(cand.payload)); } catch(e) {}
    }
  }, 2000);
}

document.getElementById("start").onclick = startStreamer;
</script>
</body>
</html>
