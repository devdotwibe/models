<!DOCTYPE html>
<html>
<head>
  <title>Live Viewer</title>
</head>
<body>
  <h2>Live Stream Viewer</h2>
  <video id="video" width="640" height="480" controls autoplay></video>

  <script>
    const video = document.getElementById('video');
    const mediaSource = new MediaSource();
    let sourceBuffer;
    let chunkIndex = 0;

    video.src = URL.createObjectURL(mediaSource);

    mediaSource.addEventListener('sourceopen', () => {
      const mime = 'video/webm; codecs="vp8,opus"';

      if (MediaSource.isTypeSupported(mime)) {
        sourceBuffer = mediaSource.addSourceBuffer(mime);
        fetchNextChunk();
      } else {
        alert("Unsupported MIME type: " + mime);
      }
    });

    async function fetchNextChunk() {
      while (true) {
        try {
          const response = await fetch(`stream_chunk.php?index=${chunkIndex}`);

          if (response.status === 204) {
            // No new chunk, wait a bit
            await new Promise(r => setTimeout(r, 1000));
            continue;
          }

          const chunk = await response.arrayBuffer();
          if (!sourceBuffer.updating) {
            sourceBuffer.appendBuffer(chunk);
            chunkIndex++;
          } else {
            await new Promise(resolve => {
              sourceBuffer.addEventListener('updateend', resolve, { once: true });
              sourceBuffer.appendBuffer(chunk);
              chunkIndex++;
            });
          }
        } catch (err) {
          console.error("Error fetching chunk", err);
          await new Promise(r => setTimeout(r, 2000));
        }
      }
    }
  </script>
</body>
</html>
