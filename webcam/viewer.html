<!DOCTYPE html>
<html>
<head>
  <title>Live Stream Viewer</title>
</head>
<body>
  <h2>Live Stream Viewer with MediaSource</h2>
  <video id="video" width="640" height="480" controls autoplay></video>

  <script>
    const video = document.getElementById('video');
    const mediaSource = new MediaSource();
    video.src = URL.createObjectURL(mediaSource);

    let sourceBuffer;
    let chunkIndex = 0;

    mediaSource.addEventListener('sourceopen', () => {
      const mime = 'video/webm; codecs="vp8,opus"';

      if (!MediaSource.isTypeSupported(mime)) {
        alert('Unsupported MIME type: ' + mime);
        return;
      }

      sourceBuffer = mediaSource.addSourceBuffer(mime);
      fetchNextChunk(); // start polling
    });

    async function fetchNextChunk() {
      while (true) {
        // Prevent trying to append if media source is closed
        if (mediaSource.readyState !== 'open') {
          console.warn('MediaSource is not open. Stopping...');
          break;
        }

        try {
          const response = await fetch(`stream_chunk.php?index=${chunkIndex}`);

          if (response.status === 204) {
            await sleep(1000); // wait for new chunk
            continue;
          }

          const chunk = await response.arrayBuffer();
          await appendChunk(chunk); // safely append
          chunkIndex++;

        } catch (err) {
          console.error('Error fetching/appending chunk:', err);
          await sleep(2000);
        }
      }
    }

    function appendChunk(chunk) {
      return new Promise(resolve => {
        if (mediaSource.readyState !== 'open') {
          console.warn('Cannot append, media source closed');
          return resolve();
        }

        if (!sourceBuffer.updating) {
          try {
            sourceBuffer.appendBuffer(chunk);
            resolve();
          } catch (e) {
            console.error("appendBuffer failed:", e);
            resolve();
          }
        } else {
          sourceBuffer.addEventListener('updateend', function handler() {
            sourceBuffer.removeEventListener('updateend', handler);
            if (mediaSource.readyState === 'open') {
              try {
                sourceBuffer.appendBuffer(chunk);
              } catch (e) {
                console.error("Delayed appendBuffer failed:", e);
              }
            }
            resolve();
          });
        }
      });
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    mediaSource.addEventListener('sourceclose', () => {
      console.warn('MediaSource closed.');
    });

    mediaSource.addEventListener('sourceended', () => {
      console.warn('MediaSource ended.');
    });
  </script>
</body>
</html>
