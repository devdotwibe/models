<!DOCTYPE html>
<html>
<head><title>Viewer</title></head>
<body>
<h2>Viewer</h2>
<video id="remote" autoplay playsinline controls width="600"></video>

<script>
const remote = document.getElementById('remote');
let pc;

async function pollForOffer() {
    const res = await fetch('get_offer.php');
    const { offer } = await res.json();
    if (offer && !pc) {
        startViewer(offer);
    }
    setTimeout(pollForOffer, 1500);
}
pollForOffer();

async function startViewer(offer) {
    pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    pc.ontrack = (event) => remote.srcObject = event.streams[0];
    pc.onicecandidate = ({ candidate }) => {
        if (!candidate) {
            fetch('save_answer.php', {
                method: 'POST',
                body: JSON.stringify({ answer: pc.localDescription }),
                headers: { 'Content-Type': 'application/json' }
            });
        }
    };

    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
}
</script>
</body>
</html>
