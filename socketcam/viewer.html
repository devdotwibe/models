<!DOCTYPE html>
<html>
<head><title>Viewer</title></head>
<body>
<h2>Viewer</h2>
<video id="remote" autoplay playsinline controls width="600"></video>

<script>
const ws = new WebSocket("wss://models.staging3.dotwibe.com/webrtcsocket"); 
const remote = document.getElementById('remote');
let pc;

ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'viewer' }));
};

ws.onmessage = ({ data }) => {
    const msg = JSON.parse(data);

    if (msg.type === 'signal') {
        const { offer, candidate } = msg.data;
        if (!pc && offer) {
            pc = createPeerConnection();
            pc.setRemoteDescription(new RTCSessionDescription(offer));
            pc.createAnswer().then(answer => {
                pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ to: 'streamer', payload: { answer } }));
            });
        }
        if (pc && candidate) {
            pc.addIceCandidate(new RTCIceCandidate(candidate));
        }
    }
};

function createPeerConnection() {
    const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    pc.ontrack = (event) => remote.srcObject = event.streams[0];
    pc.onicecandidate = ({ candidate }) => {
        if (candidate) {
            ws.send(JSON.stringify({ to: 'streamer', payload: { candidate } }));
        }
    };
    return pc;
}
</script>
</body>
</html>
