<!-- streamer.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streamer</title>
</head>
<body>
    <h2>Streamer</h2>
    <video id="preview" autoplay muted playsinline width="600"></video><br>
    <button onclick="startStreaming()">Start Streaming</button>
    <button onclick="stopStreaming()">Stop</button>

    <script>
        const preview = document.getElementById("preview");
        const socket = new WebSocket("wss://models.staging3.dotwibe.com/webrtcsocket");

        let stream, recorder;
        let seqnce_no = 0;
        let isStreaming = false;
        let headerChunk = null; // Save first chunk for new viewers

        socket.addEventListener('open', () => {
            console.log('WebSocket connection opened');
        });

        socket.addEventListener('message', ({ data }) => {
            const msg = JSON.parse(data);
            console.log('Received message:', msg);

            if (msg.event === 'new-viewer') {
                console.log('New viewer joined, sending header chunk.');
                if (headerChunk) {
                    socket.send(JSON.stringify({
                        event: 'stream-chunk',
                        data: headerChunk,
                        private_id: -1
                    }));
                }
            }
        });

        async function startStreaming() {
            if (isStreaming) return;
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                preview.srcObject = stream;

                recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' });
                isStreaming = true;

                recorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const arrayBuffer = reader.result;
                            const base64 = arrayBufferToBase64(arrayBuffer);
                            if (!headerChunk) {
                                headerChunk = base64;
                            }
                            socket.send(JSON.stringify({
                                event: 'stream-chunk',
                                data: base64,
                                private_id: seqnce_no
                            }));
                            seqnce_no++;
                        };
                        reader.readAsArrayBuffer(event.data);
                    }
                };

                recorder.start(1000); // Send 1-second chunks
                console.log("Streaming started");
            } catch (error) {
                console.error('Error starting streaming:', error);
            }
        }

        function stopStreaming() {
            if (!isStreaming) return;
            if (recorder && recorder.state !== "inactive") {
                recorder.stop();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                preview.srcObject = null;
            }
            isStreaming = false;
            headerChunk = null;
            console.log("Streaming stopped");
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            bytes.forEach(b => binary += String.fromCharCode(b));
            return btoa(binary);
        }
    </script>
</body>
</html>
