<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streamer</title>
</head>
<body>
    <h2>Streamer</h2>
    <video id="preview" autoplay muted playsinline width="600"></video><br>
    <button onclick="startStreaming()">Start Streaming</button>
    <button onclick="stopStreaming()">Stop</button>

    <script>
        const preview = document.getElementById("preview");
        const socket = new WebSocket("wss://models.staging3.dotwibe.com/webrtcsocket");
        let stream, recorder;
        let seqnce_no = 0;
        let isStreaming = false;

        socket.onmessage = ({ data }) => {
            const msg = JSON.parse(data);
            if (msg.event === 'new-viewer' && isStreaming) {
                // Stop and restart to help new viewer
                stopStreaming();
                setTimeout(() => startStreaming(), 500);
            }
        };

        async function startStreaming() {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            preview.srcObject = stream;

            recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' });
            isStreaming = true;

            recorder.ondataavailable = (event) => {
                if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const arrayBuffer = reader.result;
                        const base64 = arrayBufferToBase64(arrayBuffer);
                        socket.send(JSON.stringify({
                            event: 'stream-chunk',
                            data: base64,
                            private_id: seqnce_no
                        }));
                        seqnce_no++;
                    };
                    reader.readAsArrayBuffer(event.data);
                }
            };

            recorder.start(1000); // 1-second chunks
            console.log("Streaming started");
        }

        function stopStreaming() {
            if (recorder && recorder.state !== "inactive") {
                recorder.stop();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                preview.srcObject = null;
            }
            isStreaming = false;
            console.log("Streaming stopped");
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            bytes.forEach(b => binary += String.fromCharCode(b));
            return btoa(binary);
        }
    </script>
</body>
</html>
