<!DOCTYPE html>
<html>
<head><title>Streamer</title></head>
<body>
<h2>Streamer</h2>
<video id="preview" autoplay muted playsinline width="600"></video>

<script>
const preview = document.getElementById('preview');
let pc;

navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
    preview.srcObject = stream;
    pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    stream.getTracks().forEach(track => pc.addTrack(track, stream));

    pc.onicecandidate = ({ candidate }) => {
        if (!candidate) {
            fetch('save_offer.php', {
                method: 'POST',
                body: JSON.stringify({ offer: pc.localDescription }),
                headers: { 'Content-Type': 'application/json' }
            });
        }
    };

    pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
    });
});

async function pollForAnswer() {
    const res = await fetch('get_answer.php');
    const { answer } = await res.json();
    if (answer && pc.signalingState !== 'stable') {
        await pc.setRemoteDescription(answer);
        console.log('Answer received and set.');
    }
    setTimeout(pollForAnswer, 1000);
}
pollForAnswer();
</script>
</body>
</html>
