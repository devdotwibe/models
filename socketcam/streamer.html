<!DOCTYPE html>
<html>
<head><title>Streamer</title></head>
<body>
<h2>Streamer</h2>
<video id="preview" autoplay muted playsinline width="600"></video>

<script>
const ws = new WebSocket("ws://staging3.dotwibe.com:9001");
let pc;
const preview = document.getElementById('preview');

const iceServers = [
    { urls: 'stun:stun.l.google.com:19302' },
    {
        urls: 'turn:relay.metered.ca:80',
        username: 'openai',
        credential: 'openai'
    }
];

navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
    preview.srcObject = stream;
    ws.onopen = () => ws.send(JSON.stringify({ type: 'streamer-ready' }));

    ws.onmessage = ({ data }) => {
        const msg = JSON.parse(data);
        if (msg.type === 'viewer-ready') {
            startConnection(stream);
        } else if (msg.type === 'answer' && pc) {
            pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
        } else if (msg.type === 'candidate' && pc) {
            pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
        }
    };
});

function startConnection(stream) {
    pc = new RTCPeerConnection({ iceServers });
    stream.getTracks().forEach(track => pc.addTrack(track, stream));
    pc.onicecandidate = ({ candidate }) => {
        if (candidate) {
            ws.send(JSON.stringify({ type: 'candidate', candidate }));
        }
    };
    pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: 'offer', offer }));
    });
}
</script>
</body>
</html>
